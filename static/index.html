<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtIntellect - æ™ºèƒ½ ArXiv è®ºæ–‡åŠ©æ‰‹</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .paper-card {
            transition: all 0.3s ease;
        }
        
        .paper-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        
        .dark .paper-card {
            background: #1f2937;
        }
        
        .dark .paper-card:hover {
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        .chat-message {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="gradient-bg text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-brain text-3xl"></i>
                    <h1 class="text-2xl font-bold">ArtIntellect</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                    <div id="statusIndicator" class="flex items-center space-x-2 text-sm">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        <span>åœ¨çº¿</span>
                    </div>
                    
                    <!-- æ·±è‰²æ¨¡å¼åˆ‡æ¢ -->
                    <button id="darkModeToggle" class="p-2 rounded-lg hover:bg-white/20 transition">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <!-- åˆ·æ–°æŒ‰é’® -->
                    <button onclick="fetchAllTopics()" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition flex items-center space-x-2">
                        <i class="fas fa-sync-alt"></i>
                        <span>è·å–æœ€æ–°è®ºæ–‡</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- å·¦ä¾§è¾¹æ  -->
            <aside class="lg:col-span-1 space-y-6">
                
                <!-- ä¸»é¢˜ç®¡ç†å¡ç‰‡ -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 transition-colors">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white flex items-center">
                        <i class="fas fa-tags mr-2 text-purple-600"></i>
                        æˆ‘çš„ä¸»é¢˜
                    </h2>
                    
                    <!-- æ·»åŠ ä¸»é¢˜è¡¨å• -->
                    <div class="mb-4">
                        <input 
                            type="text" 
                            id="topicName" 
                            placeholder="ä¸»é¢˜åç§°" 
                            class="w-full px-3 py-2 mb-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-purple-500 transition"
                        >
                        <input 
                            type="text" 
                            id="topicQuery" 
                            placeholder="arXiv æŸ¥è¯¢ (å¦‚: cat:cs.AI)" 
                            class="w-full px-3 py-2 mb-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-purple-500 transition"
                        >
                        <button 
                            onclick="addTopic()" 
                            class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center justify-center space-x-2"
                        >
                            <i class="fas fa-plus"></i>
                            <span>æ·»åŠ ä¸»é¢˜</span>
                        </button>
                    </div>
                    
                    <!-- ä¸»é¢˜åˆ—è¡¨ -->
                    <div id="topicsList" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- ä¸»é¢˜å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                
                <!-- æ™ºèƒ½é—®ç­”å¡ç‰‡ -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 transition-colors">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white flex items-center">
                        <i class="fas fa-robot mr-2 text-blue-600"></i>
                        æ™ºèƒ½é—®ç­” (RAG)
                    </h2>
                    
                    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                    <div id="chatMessages" class="space-y-3 mb-4 h-96 overflow-y-auto p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div class="text-center text-gray-500 dark:text-gray-400 mt-20">
                            <i class="fas fa-comments text-4xl mb-3"></i>
                            <p>å‘æˆ‘æé—®å…³äºè®ºæ–‡çš„é—®é¢˜å§ï¼</p>
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="questionInput" 
                            placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." 
                            class="flex-1 px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 transition"
                            onkeypress="if(event.key === 'Enter') askQuestion()"
                        >
                        <button 
                            onclick="askQuestion()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- å¿«æ·æ“ä½œ -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 transition-colors">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white flex items-center">
                        <i class="fas fa-bolt mr-2 text-yellow-600"></i>
                        å¿«æ·æ“ä½œ
                    </h2>
                    
                    <div class="space-y-2">
                        <button 
                            onclick="showAllPapers()" 
                            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition flex items-center justify-between"
                        >
                            <span>æ‰€æœ‰è®ºæ–‡</span>
                            <i class="fas fa-file-alt"></i>
                        </button>
                        
                        <button 
                            onclick="showFavorites()" 
                            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition flex items-center justify-between"
                        >
                            <span>æ”¶è—å¤¹</span>
                            <i class="fas fa-star"></i>
                        </button>
                        
                        <button 
                            onclick="buildIndex()" 
                            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition flex items-center justify-between"
                        >
                            <span>å»ºç«‹ç´¢å¼•</span>
                            <i class="fas fa-database"></i>
                        </button>
                    </div>
                </div>
            </aside>
            
            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <main class="lg:col-span-3">
                
                <!-- æœç´¢æ  -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 transition-colors">
                    <div class="flex space-x-3">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="æœç´¢è®ºæ–‡æˆ–ä» arXiv è·å–..." 
                            class="flex-1 px-4 py-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-purple-500 transition text-lg"
                            onkeypress="if(event.key === 'Enter') searchArxiv()"
                        >
                        <button 
                            onclick="searchArxiv()" 
                            class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center space-x-2 font-medium"
                        >
                            <i class="fas fa-search"></i>
                            <span>æœç´¢</span>
                        </button>
                    </div>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div id="statsBar" class="mt-4 flex items-center justify-between text-sm text-gray-600 dark:text-gray-400">
                        <span id="paperCount">åŠ è½½ä¸­...</span>
                        <span id="indexStats">ç´¢å¼•: --</span>
                    </div>
                </div>
                
                <!-- è®ºæ–‡åˆ—è¡¨ -->
                <div id="papersList" class="space-y-4">
                    <!-- è®ºæ–‡å¡ç‰‡å°†åŠ¨æ€åŠ è½½ -->
                    <div class="text-center py-20">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-500 dark:text-gray-400">åŠ è½½è®ºæ–‡ä¸­...</p>
                    </div>
                </div>
                
            </main>
            
        </div>
    </div>
    
    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <script>
        // ===== å…¨å±€å˜é‡ =====
        let currentPapers = [];
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', () => {
            initDarkMode();
            loadTopics();
            loadPapers();
            updateStats();
        });
        
        // ===== æ·±è‰²æ¨¡å¼ =====
        function initDarkMode() {
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
        }
        
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            document.documentElement.classList.toggle('dark');
            document.getElementById('darkModeToggle').innerHTML = isDarkMode 
                ? '<i class="fas fa-sun"></i>' 
                : '<i class="fas fa-moon"></i>';
        });
        
        // ===== Toast é€šçŸ¥ =====
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 animate-fade-in`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ===== API è¯·æ±‚å°è£… =====
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API è¯·æ±‚å¤±è´¥:', error);
                showToast(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // ===== ä¸»é¢˜ç®¡ç† =====
        async function loadTopics() {
            try {
                const data = await apiRequest('/api/topics');
                const topicsList = document.getElementById('topicsList');
                
                if (data.topics.length === 0) {
                    topicsList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm text-center">æš‚æ— ä¸»é¢˜</p>';
                    return;
                }
                
                topicsList.innerHTML = data.topics.map(topic => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 dark:text-white">${topic.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${topic.query}</div>
                        </div>
                        <button onclick="deleteTopic(${topic.id})" class="text-red-500 hover:text-red-700 ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
            }
        }
        
        async function addTopic() {
            const name = document.getElementById('topicName').value.trim();
            const query = document.getElementById('topicQuery').value.trim();
            
            if (!name || !query) {
                showToast('è¯·å¡«å†™ä¸»é¢˜åç§°å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²', 'warning');
                return;
            }
            
            try {
                await apiRequest('/api/topics', {
                    method: 'POST',
                    body: JSON.stringify({ name, query })
                });
                
                document.getElementById('topicName').value = '';
                document.getElementById('topicQuery').value = '';
                
                showToast('ä¸»é¢˜æ·»åŠ æˆåŠŸ', 'success');
                loadTopics();
            } catch (error) {
                showToast('æ·»åŠ ä¸»é¢˜å¤±è´¥', 'error');
            }
        }
        
        async function deleteTopic(topicId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¸»é¢˜å—ï¼Ÿ')) return;
            
            try {
                await apiRequest(`/api/topics/${topicId}`, { method: 'DELETE' });
                showToast('ä¸»é¢˜åˆ é™¤æˆåŠŸ', 'success');
                loadTopics();
            } catch (error) {
                showToast('åˆ é™¤ä¸»é¢˜å¤±è´¥', 'error');
            }
        }
        
        // ===== è®ºæ–‡ç®¡ç† =====
        async function loadPapers(favoriteOnly = false) {
            try {
                const url = favoriteOnly 
                    ? '/api/favorites' 
                    : '/api/papers?limit=100';
                
                const data = await apiRequest(url);
                currentPapers = data.papers;
                displayPapers(currentPapers);
                
                document.getElementById('paperCount').textContent = `å…± ${data.count} ç¯‡è®ºæ–‡`;
            } catch (error) {
                console.error('åŠ è½½è®ºæ–‡å¤±è´¥:', error);
                document.getElementById('papersList').innerHTML = `
                    <div class="text-center py-20 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p>åŠ è½½è®ºæ–‡å¤±è´¥</p>
                    </div>
                `;
            }
        }
        
        function displayPapers(papers) {
            const papersList = document.getElementById('papersList');
            
            if (papers.length === 0) {
                papersList.innerHTML = `
                    <div class="text-center py-20 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-inbox text-6xl mb-4"></i>
                        <p class="text-xl">æš‚æ— è®ºæ–‡</p>
                        <p class="text-sm mt-2">æ·»åŠ ä¸»é¢˜åç‚¹å‡»"è·å–æœ€æ–°è®ºæ–‡"æŒ‰é’®</p>
                    </div>
                `;
                return;
            }
            
            papersList.innerHTML = papers.map(paper => createPaperCard(paper)).join('');
        }
        
        function createPaperCard(paper) {
            const isFavorite = paper.is_favorite || false;
            const publishDate = new Date(paper.published).toLocaleDateString('zh-CN');
            
            return `
                <div class="paper-card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 transition-colors" data-paper-id="${paper.id}">
                    <!-- æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® -->
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white flex-1 mr-4">
                            ${paper.title}
                        </h3>
                        <button 
                            onclick="toggleFavorite('${paper.id}', ${isFavorite})" 
                            class="text-2xl ${isFavorite ? 'text-yellow-500' : 'text-gray-400'} hover:text-yellow-500 transition"
                        >
                            <i class="fas fa-star"></i>
                        </button>
                    </div>
                    
                    <!-- å…ƒä¿¡æ¯ -->
                    <div class="flex flex-wrap gap-2 mb-3 text-sm">
                        <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded">
                            <i class="fas fa-calendar mr-1"></i>${publishDate}
                        </span>
                        <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded">
                            <i class="fas fa-tag mr-1"></i>${paper.categories.split(',')[0]}
                        </span>
                    </div>
                    
                    <!-- ä½œè€… -->
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        <i class="fas fa-users mr-1"></i>${paper.authors.split(',').slice(0, 3).join(', ')}${paper.authors.split(',').length > 3 ? ' ...' : ''}
                    </p>
                    
                    <!-- æ‘˜è¦ -->
                    <div class="mb-4">
                        <div class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed mb-2" id="summary-${paper.id}">
                            ${paper.summary.substring(0, 300)}...
                        </div>
                        <div class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed mb-2 hidden" id="translation-${paper.id}">
                            <!-- ç¿»è¯‘å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex flex-wrap gap-2">
                        <button 
                            onclick="translateSummary('${paper.id}')" 
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm flex items-center space-x-1"
                        >
                            <i class="fas fa-language"></i>
                            <span>ç¿»è¯‘</span>
                        </button>
                        
                        <a 
                            href="${paper.pdf_url}" 
                            target="_blank" 
                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm flex items-center space-x-1"
                        >
                            <i class="fas fa-file-pdf"></i>
                            <span>PDF</span>
                        </a>
                        
                        <a 
                            href="https://arxiv.org/abs/${paper.id}" 
                            target="_blank" 
                            class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm flex items-center space-x-1"
                        >
                            <i class="fas fa-external-link-alt"></i>
                            <span>arXiv</span>
                        </a>
                    </div>
                </div>
            `;
        }
        
        // ===== ç¿»è¯‘åŠŸèƒ½ =====
        async function translateSummary(paperId) {
            const summaryDiv = document.getElementById(`summary-${paperId}`);
            const translationDiv = document.getElementById(`translation-${paperId}`);
            const paper = currentPapers.find(p => p.id === paperId);
            
            if (!paper) return;
            
            // å¦‚æœå·²ç»æ˜¾ç¤ºç¿»è¯‘ï¼Œåˆ™åˆ‡æ¢æ˜¾ç¤º
            if (!translationDiv.classList.contains('hidden')) {
                translationDiv.classList.add('hidden');
                summaryDiv.classList.remove('hidden');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            translationDiv.innerHTML = '<div class="flex items-center space-x-2"><div class="spinner"></div><span>ç¿»è¯‘ä¸­...</span></div>';
            translationDiv.classList.remove('hidden');
            summaryDiv.classList.add('hidden');
            
            try {
                const data = await apiRequest('/api/translate', {
                    method: 'POST',
                    body: JSON.stringify({ text: paper.summary })
                });
                
                translationDiv.innerHTML = `
                    <div class="border-l-4 border-green-500 pl-3">
                        ${data.translated}
                    </div>
                `;
            } catch (error) {
                translationDiv.innerHTML = '<p class="text-red-500">ç¿»è¯‘å¤±è´¥</p>';
                showToast('ç¿»è¯‘å¤±è´¥', 'error');
            }
        }
        
        // ===== æ”¶è—åŠŸèƒ½ =====
        async function toggleFavorite(paperId, isFavorite) {
            try {
                if (isFavorite) {
                    await apiRequest(`/api/favorites/${paperId}`, { method: 'DELETE' });
                    showToast('å·²å–æ¶ˆæ”¶è—', 'success');
                } else {
                    await apiRequest(`/api/favorites/${paperId}`, { method: 'POST' });
                    showToast('å·²æ·»åŠ æ”¶è—', 'success');
                }
                
                // é‡æ–°åŠ è½½å½“å‰è§†å›¾
                if (document.getElementById('papersList').getAttribute('data-view') === 'favorites') {
                    showFavorites();
                } else {
                    loadPapers();
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        // ===== æœç´¢åŠŸèƒ½ =====
        async function searchArxiv() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
                return;
            }
            
            document.getElementById('papersList').innerHTML = `
                <div class="text-center py-20">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-500 dark:text-gray-400">æ­£åœ¨ä» arXiv æœç´¢...</p>
                </div>
            `;
            
            try {
                const data = await apiRequest('/api/arxiv/search', {
                    method: 'POST',
                    body: JSON.stringify({ query, max_results: 20 })
                });
                
                showToast(data.message, 'success');
                setTimeout(() => loadPapers(), 1000);
            } catch (error) {
                showToast('æœç´¢å¤±è´¥', 'error');
                loadPapers();
            }
        }
        
        // ===== è·å–æ‰€æœ‰ä¸»é¢˜è®ºæ–‡ =====
        async function fetchAllTopics() {
            showToast('å¼€å§‹è·å–è®ºæ–‡...', 'info');
            
            try {
                const data = await apiRequest('/api/arxiv/fetch-all', { method: 'POST' });
                showToast(data.message, 'success');
                setTimeout(() => loadPapers(), 1000);
            } catch (error) {
                showToast('è·å–å¤±è´¥', 'error');
            }
        }
        
        // ===== æ˜¾ç¤ºæ‰€æœ‰è®ºæ–‡ =====
        function showAllPapers() {
            document.getElementById('papersList').setAttribute('data-view', 'all');
            loadPapers(false);
        }
        
        // ===== æ˜¾ç¤ºæ”¶è—å¤¹ =====
        function showFavorites() {
            document.getElementById('papersList').setAttribute('data-view', 'favorites');
            loadPapers(true);
        }
        
        // ===== å»ºç«‹ç´¢å¼• =====
        async function buildIndex() {
            try {
                const data = await apiRequest('/api/index/build', { method: 'POST' });
                showToast(data.message, 'success');
                setTimeout(updateStats, 2000);
            } catch (error) {
                showToast('å»ºç«‹ç´¢å¼•å¤±è´¥', 'error');
            }
        }
        
        // ===== æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ =====
        async function updateStats() {
            try {
                const data = await apiRequest('/api/index/stats');
                const stats = data.stats;
                
                if (stats.status === 'available') {
                    document.getElementById('indexStats').textContent = `ç´¢å¼•: ${stats.total_indexed} ç¯‡`;
                } else {
                    document.getElementById('indexStats').textContent = 'ç´¢å¼•: ä¸å¯ç”¨';
                }
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // ===== æ™ºèƒ½é—®ç­” =====
        async function askQuestion() {
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            if (!question) {
                showToast('è¯·è¾“å…¥é—®é¢˜', 'warning');
                return;
            }
            
            const chatMessages = document.getElementById('chatMessages');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message bg-purple-100 dark:bg-purple-900 p-3 rounded-lg';
            userMessage.innerHTML = `
                <div class="font-medium text-purple-900 dark:text-purple-100 mb-1">ä½ </div>
                <div class="text-gray-800 dark:text-gray-200">${question}</div>
            `;
            chatMessages.appendChild(userMessage);
            
            // æ·»åŠ åŠ è½½æ¶ˆæ¯
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'chat-message bg-blue-100 dark:bg-blue-900 p-3 rounded-lg';
            loadingMessage.id = 'loading-message';
            loadingMessage.innerHTML = `
                <div class="font-medium text-blue-900 dark:text-blue-100 mb-1">AI åŠ©æ‰‹</div>
                <div class="flex items-center space-x-2">
                    <div class="spinner"></div>
                    <span class="text-gray-800 dark:text-gray-200">æ€è€ƒä¸­...</span>
                </div>
            `;
            chatMessages.appendChild(loadingMessage);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
            questionInput.value = '';
            
            try {
                // ä½¿ç”¨ EventSource è¿›è¡Œæµå¼æ¥æ”¶
                const response = await fetch('/api/qa/ask-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, top_k: 5 })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                loadingMessage.remove();
                
                const assistantMessage = document.createElement('div');
                assistantMessage.className = 'chat-message bg-blue-100 dark:bg-blue-900 p-3 rounded-lg';
                assistantMessage.innerHTML = `
                    <div class="font-medium text-blue-900 dark:text-blue-100 mb-1">AI åŠ©æ‰‹</div>
                    <div class="text-gray-800 dark:text-gray-200" id="answer-content"></div>
                    <div class="mt-3 space-y-1" id="sources-content"></div>
                `;
                chatMessages.appendChild(assistantMessage);
                
                const answerContent = document.getElementById('answer-content');
                const sourcesContent = document.getElementById('sources-content');
                let answerText = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.type === 'answer') {
                                answerText += data.content;
                                answerContent.textContent = answerText;
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            } else if (data.type === 'sources') {
                                sourcesContent.innerHTML = `
                                    <div class="text-xs text-gray-600 dark:text-gray-400 font-medium mt-2">å‚è€ƒæ¥æº:</div>
                                    ${data.content.map(source => `
                                        <div class="text-xs">
                                            <a href="${source.pdf_url}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">
                                                ğŸ“„ ${source.title}
                                            </a>
                                        </div>
                                    `).join('')}
                                `;
                            } else if (data.type === 'error') {
                                answerContent.innerHTML = `<span class="text-red-500">${data.content}</span>`;
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('é—®ç­”å¤±è´¥:', error);
                document.getElementById('loading-message')?.remove();
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100 dark:bg-red-900 p-3 rounded-lg';
                errorMessage.innerHTML = `
                    <div class="font-medium text-red-900 dark:text-red-100 mb-1">é”™è¯¯</div>
                    <div class="text-gray-800 dark:text-gray-200">é—®ç­”å¤±è´¥: ${error.message}</div>
                `;
                chatMessages.appendChild(errorMessage);
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>
